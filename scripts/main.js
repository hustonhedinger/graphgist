"use strict";function convertResult(data){for(var result={columns:[],data:[]},columns=data.columns,count=columns.length,rows=data.json.length,col=0;count>col;col++)result.columns[col]={sTitle:columns[col],sWidth:columns[col].length*CHAR_WIDTH};for(var row=0;rows>row;row++){for(var currentRow=data.json[row],newRow=[],col=0;count>col;col++){var value=convertCell(currentRow[columns[col]]);newRow[col]=value,result.columns[col].sWidth=Math.max(value.length*CHAR_WIDTH,result.columns[col].sWidth)}result.data[row]=newRow}for(var width=0,col=0;count>col;col++)width+=result.columns[col].sWidth;for(var col=0;count>col;col++)result.columns[col].sWidth=""+Math.round(100*result.columns[col].sWidth/width)+"%";return result}function convertCell(cell){if(null==cell)return"<null>";if(cell instanceof Array){for(var result=[],i=0;i<cell.length;i++)result.push(convertCell(cell[i]));return"["+result.join(", ")+"]"}if(cell instanceof Object){if(cell._type)return"("+cell._start+")-["+cell._id+":"+cell._type+props(cell)+"]->("+cell._end+")";if(cell._id){var labels="";return cell._labels&&(labels=":"+cell._labels.join(":")),"("+cell._id+labels+props(cell)+")"}return props(cell)}return cell}function props(cell){var props=[];for(var key in cell)cell.hasOwnProperty(key)&&"_"!=key[0]&&props.push([key]+":"+JSON.stringify(cell[key]));return props.length?" {"+props.join(", ")+"}":""}function renderTable(element,data){if(!data||!1 in data||!1 in data.stats)return!1;{var result=convertResult(data),table=$TABLE.clone().appendTo($(element)),large=result.data.length>10;table.dataTable({aoColumns:result.columns,bFilter:large,bInfo:large,bLengthChange:large,bPaginate:large,aaData:result.data,aLengthMenu:[[10,25,50,-1],[10,25,50,"All"]],aaSorting:[],bSortable:!0,oLanguage:{oPaginate:{sNext:" >> ",sPrevious:" << "}}})}return!0}function Neod3Renderer(){function dummyFunc(){}function render(id,$container,visualization){function extract_props(pc){var p={};for(var key in pc)pc.hasOwnProperty(key)&&-1==skip.indexOf(key)&&(p[key]=pc[key]);return p}function node_styles(nodes){function label(n){var labels=n.labels;return labels&&labels.length?labels[labels.length-1]:""}for(var style={},i=0;i<nodes.length;i++){var props=nodes[i].properties=extract_props(nodes[i]),keys=Object.keys(props);if(""!==label(nodes[i])&&keys.length>0){var selected_keys=prio_props.filter(function(k){return-1!==keys.indexOf(k)});selected_keys=selected_keys.concat(keys).concat(["id"]);var selector="node."+label(nodes[i]),selectedKey=selected_keys[0];"string"==typeof props[selectedKey]&&props[selectedKey].length>30&&(props[selectedKey]=props[selectedKey].substring(0,30)+" ..."),style[selector]=style[selector]||selectedKey}}return style}function style_sheet(styles,styleContents){var styleItems=[],colors=neo.style.defaults.colors;for(var selector in styles){var styleItem;if(selector in existingStyles)styleItem=existingStyles[selector];else{var color=colors[currentColor];currentColor=(currentColor+1)%colors.length;var textColor=window.isInternetExplorer?"#000000":color["text-color-internal"];styleItem=selector+" {caption: '{"+styles[selector]+"}'; color: "+color.color+"; border-color: "+color["border-color"]+"; text-color-internal: "+textColor+"; text-color-external: "+textColor+"; }",existingStyles[selector]=styleItem}styleItems.push(styleItem)}return styleContents+styleItems.join("\n")}function applyZoom(){renderer.select(".nodes").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),renderer.select(".relationships").attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function enableZoomHandlers(){renderer.on("wheel.zoom",zoomHandlers.wheel),renderer.on("mousewheel.zoom",zoomHandlers.mousewheel),renderer.on("mousedown.zoom",zoomHandlers.mousedown),renderer.on("DOMMouseScroll.zoom",zoomHandlers.DOMMouseScroll),renderer.on("touchstart.zoom",zoomHandlers.touchstart),renderer.on("touchmove.zoom",zoomHandlers.touchmove),renderer.on("touchend.zoom",zoomHandlers.touchend)}function disableZoomHandlers(){renderer.on("wheel.zoom",null),renderer.on("mousewheel.zoom",null),renderer.on("mousedown.zoom",null),renderer.on("DOMMouseScroll.zoom",null),renderer.on("touchstart.zoom",null),renderer.on("touchmove.zoom",null),renderer.on("touchend.zoom",null)}function keyHandler(){d3.event.altKey||d3.event.shiftKey?enableZoomHandlers():disableZoomHandlers()}function refresh(){graphView.height($container.height()),graphView.width($container.width()),renderer.call(graphView)}function saveToSvg(){var svgElement=$("#"+id).children("svg").first()[0],xml=serializeSvg(svgElement,$container);msBlobSupport||"#"===downloadSvgLink.href||window.URL.revokeObjectURL(downloadSvgLink.href);var blob=new window.Blob([xml],{type:"image/svg+xml"}),fileName=id+".svg";msBlobSupport?window.navigator.msSaveOrOpenBlob(blob,fileName):(downloadSvgLink.href=window.URL.createObjectURL(blob),$downloadSvgLink.appendTo($container).show(),$downloadSvgLink.attr("download",fileName))}function getFunctions(){var funcs={};return blobSupport&&(URLSupport||msBlobSupport)&&(funcs["icon-download-alt"]={title:"Save as SVG",func:saveToSvg}),funcs}for(var links=visualization.links,nodes=visualization.nodes,i=0;i<links.length;i++)links[i].source=links[i].start,links[i].target=links[i].end,links[i].properties=props(links[i]);var nodeStyles=node_styles(nodes),styleSheet=style_sheet(nodeStyles,styleContents),graphModel=neo.graphModel().nodes(nodes).relationships(links),graphView=neo.graphView().style(styleSheet).width($container.width()).height($container.height()).on("nodeClicked",dummyFunc).on("relationshipClicked",dummyFunc).on("nodeDblClicked",dummyFunc),renderer=d3.select("#"+id).append("svg").data([graphModel]),zoomHandlers={},zoomBehavior=d3.behavior.zoom().on("zoom",applyZoom).scaleExtent([.2,8]);return renderer.call(graphView),renderer.call(zoomBehavior),zoomHandlers.wheel=renderer.on("wheel.zoom"),zoomHandlers.mousewheel=renderer.on("mousewheel.zoom"),zoomHandlers.mousedown=renderer.on("mousedown.zoom"),zoomHandlers.DOMMouseScroll=renderer.on("DOMMouseScroll.zoom"),zoomHandlers.touchstart=renderer.on("touchstart.zoom"),zoomHandlers.touchmove=renderer.on("touchmove.zoom"),zoomHandlers.touchend=renderer.on("touchend.zoom"),disableZoomHandlers(),d3.select("body").on("keydown",keyHandler).on("keyup",keyHandler),{subscriptions:{expand:refresh,contract:refresh,sizeChange:refresh},actions:getFunctions()}}function serializeSvg(element,$container){if(null===serializer)if("undefined"!=typeof window.XMLSerializer){var xmlSerializer=new XMLSerializer;serializer=function(emnt){return xmlSerializer.serializeToString(emnt)}}else serializer=function(emnt){return'<svg xmlns="http://www.w3.org/2000/svg">'+$(emnt).html()+"</svg>"};var svg=serializer(element);return svg=svg.replace("<svg ",'<svg height="'+$container.height()+'" width="'+$container.width()+'" ').replace(/<g/,"\n"+svgStyling+"\n<g")}var styleContents="node {          diameter: 40px;          color: #DFE1E3;          border-color: #D4D6D7;          border-width: 2px;          text-color-internal: #000000;          text-color-external: #000000;          caption: '{name}';          font-size: 12px;        }        relationship {          color: #4356C0;          shaft-width: 3px;          font-size: 9px;          padding: 3px;          text-color-external: #000000;          text-color-internal: #FFFFFF;        }\n",skip=["id","start","end","source","target","labels","type","selected"],prio_props=["name","title","tag","username","lastname"],serializer=null,$downloadSvgLink=$('<a href="#" class="btn btn-success visualization-download" target="_blank"><i class="icon-download-alt"></i> Download SVG</a>').hide().click(function(){$downloadSvgLink.hide()}),downloadSvgLink=$downloadSvgLink[0],blobSupport="Blob"in window,URLSupport="URL"in window&&"createObjectURL"in window.URL,msBlobSupport="undefined"!=typeof window.navigator.msSaveOrOpenBlob,svgStyling="<style>\ntext{font-family:sans-serif}\n</style>",stylingUrl="www.neo4j.org"===window.location.hostname?"http://gist.neo4j.org/styles/neod3":"styles/neod3";stylingUrl+=window.isInternetExplorer?"-ie.css":".css";var existingStyles={},currentColor=1;return $.get(stylingUrl,function(data){svgStyling="<style>\n"+data+"\n</style>",$(svgStyling).appendTo("head")}),{render:render}}function GraphVisualization(){function hash(s){if(!s)return 0;for(var ret=0,i=0,len=s.length;len>i;i++)ret=31*ret+s.charCodeAt(i)<<0;return ret}function propertyHash(ob){var ret=0;for(var prop in ob)ignore.hasOwnProperty(prop)||ob.hasOwnProperty(prop)&&(ret+=hash(prop));return ret}function toString(ob){var ret="";for(var prop in ob)ignore.hasOwnProperty(prop)||ob.hasOwnProperty(prop)&&(ret+=prop+": "+ob[prop]+" ");return ret+"id: "+ob.id}function labels(ob){return ob.labels&&0!=ob.labels.length?":"+ob.labels.join(":")+" ":""}function title(ob){function _title(ob){if(ob.name)return ob.name;if(ob.title)return ob.title;for(var prop in ob)if(!ignore.hasOwnProperty(prop)&&"labels"!=prop&&ob.hasOwnProperty(prop))return ob[prop];return ob.id}return labels(ob)+_title(ob)}function visualize(elementOrId,w,h,data){var select="string"==typeof elementOrId?"#"+elementOrId:elementOrId,vis=d3.select(select).append("svg").attr("class","d3-graph").attr("width",w).attr("height",h).attr("style","pointer-events:fill;"),force=self.force=d3.layout.force().nodes(data.nodes).links(data.links).gravity(.2).distance(80).charge(-1e3).size([w,h]).start();vis.append("svg:defs").selectAll("marker").data(["end-marker"]).enter().append("svg:marker").attr("viewBox","0 -5 10 10").attr("refX",25).attr("refY",-1.5).attr("markerWidth",4).attr("markerHeight",4).attr("class","d3-marker").attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5");var link=vis.selectAll("line.link").data(data.links).enter().append("svg:line").attr("class","d3-link").attr("marker-end","url(#end-marker)").style("stroke",function(d){return d.selected?"red":null}).style("stroke-width",function(d){return d.selected?2:null}).attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y}),node=vis.selectAll("g.node").data(data.nodes).enter().append("circle").attr("class","d3-node").attr("r",5).style("fill",function(d){return color(propertyHash(d)%20)}).style("stroke-width",function(d){return d.selected?2:0}).style("stroke",function(d){return d.selected?"red":null}).call(force.drag);node.append("title").text(function(d){return toString(d)}).attr("class","d3-text");var text=vis.append("svg:g").selectAll("g").data(force.nodes()).enter().append("svg:g");text.append("svg:text").attr("x",8).attr("y","-.31em").attr("class","d3-text d3-shadow").text(function(d){return title(d)}),text.append("svg:text").attr("x",8).attr("y","-.31em").attr("class","d3-text").text(function(d){return title(d)});var path_text=vis.append("svg:g").selectAll("g").data(force.links()).enter().append("svg:g");path_text.append("svg:text").attr("class","d3-path-text d3-shadow").text(function(d){return d.type}),path_text.append("svg:text").attr("class","d3-path-text").text(function(d){return d.type}),force.on("tick",function(){link.attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y}),text.attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),node.attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),isBadChromeVersion()?console.log("Your version of Chrome under Windows can't render the graphs correctly, try a different browser."):path_text.attr("transform",function(d){var dx=d.target.x-d.source.x,dy=d.target.y-d.source.y,dr=Math.sqrt(dx*dx+dy*dy);0==dr&&(dr=.1);var sinus=dy/dr,cosinus=dx/dr,l=6*d.type.length,offset=(1-l/dr)/2,x=d.source.x+dx*offset,y=d.source.y+dy*offset;return"translate("+x+","+y+") matrix("+cosinus+", "+sinus+", "+-sinus+", "+cosinus+", 0 , 0)"})})}function isBadChromeVersion(){if(!("chrome"in window))return!1;if(-1===navigator.userAgent.indexOf("Windows NT"))return!1;var versionArray=navigator.userAgent.match(/Chrom(e|ium)\/(.*?) /)[2].split("."),first=parseInt(versionArray[0]);if(30>first)return!0;if(first>30)return!1;var second=parseInt(versionArray[1]);if(second>0)return!1;var third=parseInt(versionArray[2]);if(third>1599)return!1;if(1599>third)return!0;var fourth=parseInt(versionArray[3]);return fourth>=66?!1:!0}function render(id,w,h,url){d3.json(url,function(data){visualize(id,w,h,data)})}var color=d3.scale.category20b(),ignore={source:1,target:1,type:1,selected:1,index:1,x:1,y:1,weight:1,px:1,py:1,id:1};return{render:render,visualize:visualize}}function CypherConsole(config,ready){function createConsole(ready,elementClass,contentId){if($("code.cypher").length>0){var $element=$("p."+elementClass).first();1!==$element.length&&($element=$("<p/>").addClass(elementClass),$("#"+contentId).append($element),$element.hide()),$element.each(function(){var $context=$(this);addConsole($context,ready)}),addPlayButtons()}else ready()}function addConsole($context,ready){var url=getUrl("none","none","\n\nUse the play/edit buttons to run the queries!"),$iframe=$IFRAME.clone().attr("src",url);$iframe.load(function(){var iframeWindow=$iframe[0].contentWindow;iframeWindow&&(consolr=new Consolr($iframe[0].contentWindow),ready&&ready(consolr),window.setTimeout(function(){try{if(iframeWindow.location&&iframeWindow.location.href){var consoleLocation=iframeWindow.location.href;-1===consoleLocation.indexOf("neo4j")&&-1===consoleLocation.indexOf("localhost")&&$iframe.replaceWith('<div class="alert alert-error"><h4>Error!</h4>The console can not be loaded. Please turn off ad blockers and reload the page!</div>')}}catch(err){}},2e3))}),$context.empty();var $iframeWrapper=$IFRAME_WRAPPER.clone();$iframeWrapper.append($iframe);var $contentMoveSelector=$(contentMoveSelector).first();$context.append($iframeWrapper).append('<span id="console-label" class="label">Console expanded</span>'),$context.css("background","none");var $verticalResizeButton=$RESIZE_VERTICAL_BUTTON.clone().appendTo($iframeWrapper).mousedown(function(event){event.preventDefault()});$iframeWrapper.resizable({handles:{s:$verticalResizeButton},alsoResize:$context,minHeight:80,start:function(){$resizeOverlay.appendTo($iframeWrapper)},stop:function(){$resizeOverlay.detach()},resize:function(event,ui){$resizeIcon.hasClass(RESIZE_OUT_ICON)||$contentMoveSelector.css("margin-top",ui.size.height+11)}});var $gistForm=$("#gist-form"),contextHeight=0,$resizeButton=$RESIZE_BUTTON.clone().appendTo($iframeWrapper).click(function(){$resizeIcon.hasClass(RESIZE_OUT_ICON)?(contextHeight=$context.height(),$context.height(36),$resizeIcon.removeClass(RESIZE_OUT_ICON).addClass(RESIZE_IN_ICON),$iframeWrapper.addClass("fixed-console"),$context.addClass("fixed-console"),$contentMoveSelector.css("margin-top",$iframeWrapper.height()+11),$iframeWrapper.resizable("option","alsoResize",null),$gistForm.css("margin-right",56)):($context.height($iframeWrapper.height()),$resizeIcon.removeClass(RESIZE_IN_ICON).addClass(RESIZE_OUT_ICON),$iframeWrapper.removeClass("fixed-console"),$context.removeClass("fixed-console"),$contentMoveSelector.css("margin-top",0),$iframeWrapper.resizable("option","alsoResize",$context),$gistForm.css("margin-right",0))}),$resizeIcon=$("i",$resizeButton),$toggleConsoleShowButton=$TOGGLE_CONSOLE_HIDE_BUTTON;$toggleConsoleShowButton.insertAfter($context),$context.is(":visible")||$toggleConsoleShowButton.addClass("btn-success show-console-toggle-hidden-console"),$toggleConsoleShowButton.click(function(){$context.is(":visible")?($resizeIcon.hasClass(RESIZE_OUT_ICON)||$resizeButton.click(),$context.hide(),$toggleConsoleShowButton.addClass("show-console-toggle-hidden-console")):($context.show(),$toggleConsoleShowButton.removeClass("show-console-toggle-hidden-console"))})}function addPlayButtons(){$("div.query-wrapper").parent().append($PLAY_BUTTON.clone().click(function(event){event.preventDefault(),consolr.query([getQueryFromButton(this)])})).append($EDIT_BUTTON.clone().click(function(event){event.preventDefault(),consolr.input(getQueryFromButton(this))}))}function getQueryFromButton(button){return $(button).prevAll("div.query-wrapper").first().data("query")}function getUrl(database,command,message,session){var url=consoleUrl;return void 0!==session&&(url+=";jsessionid="+session),url+="?",void 0!==database&&(url+="init="+encodeURIComponent(database)),void 0!==command&&(url+="&query="+encodeURIComponent(command)),void 0!==message&&(url+="&message="+encodeURIComponent(message)),void 0!=window.neo4jVersion&&(url+="&version="+encodeURIComponent(neo4jVersion)),url+"&no_root=true"}var consolr,$IFRAME=$("<iframe/>").attr("id","console").addClass("cypherdoc-console"),$IFRAME_WRAPPER=$("<div/>").attr("id","console-wrapper"),RESIZE_OUT_ICON="icon-resize-full",RESIZE_IN_ICON="icon-resize-small",$RESIZE_BUTTON=$('<a class="btn btn-small btn-primary resize-toggle"><i class="'+RESIZE_OUT_ICON+'"></i></a>'),$RESIZE_VERTICAL_BUTTON=$('<span class="resize-vertical-handle ui-resizable-handle ui-resizable-s"><span/></span>'),$PLAY_BUTTON=$('<a class="run-query btn btn-small btn-success" data-toggle="tooltip" title="Execute in the console." href="#"><i class="icon-play"></i></a>'),$EDIT_BUTTON=$('<a class="edit-query btn btn-small" data-toggle="tooltip" title="Edit in the console." href="#"><i class="icon-edit"></i></a>'),$TOGGLE_CONSOLE_HIDE_BUTTON=$('<a class="btn btn-small show-console-toggle" data-toggle="tooltip"  title="Show or hide a Neo4j Console in order to try the examples in the GraphGist live."><i class="icon-edit-sign"></i> Show/Hide Live Console</a>'),$resizeOverlay=$('<div id="resize-overlay"/>'),consoleClass="consoleClass"in config?config.consoleClass:"console",contentId="contentId"in config?config.contentId:"content",contentMoveSelector="contentMoveSelector"in config?config.contentMoveSelector:"div.navbar",consoleUrl=config.url;createConsole(ready,consoleClass,contentId)}function Consolr(consoleWindow){function init(params,success,error){var index=0;(success||error)&&(receivers.push(new ResultReceiver(success,error)),index=receivers.length),consoleWindow.postMessage(JSON.stringify({action:"init",data:params,call_id:index}),"*")}function query(queries,success,error){var index=0;(success||error)&&(receivers.push(new ResultReceiver(success,error,queries.length)),index=receivers.length);var message=JSON.stringify({action:"query",data:queries,call_id:index});consoleWindow.postMessage(message,"*")}function input(query){consoleWindow.postMessage(JSON.stringify({action:"input",data:[query]}),"*")}function receiver(event){var origin=event.origin;if("string"==typeof origin&&(-1!==origin.indexOf("neo4j")||-1!==origin.indexOf("localhost"))){var result=JSON.parse(event.data);if("call_id"in result){var rr=receivers[result.call_id-1];rr(result)}}}function ResultReceiver(successFunc,errorFunc,numberOfResults){function call(result){if(0===expectedResults)return void console.log("Unexpected result",result);expectedResults--;var resultNo=numberOfResults-expectedResults-1;return result.error?errorFunc(result,resultNo):successFunc(result,resultNo)}var expectedResults=numberOfResults||1;return call}window.addEventListener("message",receiver,!1);var receivers=[];return{init:init,query:query,input:input}}function Gist($,$content){function getGistAndRenderPage(renderer,defaultSource){function success(content,link,imagesdir){successful||(successful=!0,returnCount++,renderer(content,link,imagesdir))}function error(message){console.log("Error fetching",id,message),returnCount++,successful||returnCount!==fetchers.length||errorMessage(message,id)}var id=window.location.search;if(id.length<2)id=defaultSource;else{id=id.substr(1);var idCut=id.indexOf("&");-1!==idCut&&(id=id.substring(0,idCut)),id.length>20&&"_ga="===id.substring(0,4)&&(id=defaultSource)}var fetchers=[];-1!==window.location.hostname.indexOf("www.neo4j.org")&&fetchers.push(neo4jGistFetcher);var fetcher=fetchGithubGist;id.length>8&&"dropbox-"===id.substr(0,8)?fetcher=fetchPublicDropboxFile:id.length>9&&"dropboxs-"===id.substr(0,9)?fetcher=fetchPrivateDropboxFile:id.length>7&&"github-"===id.substr(0,7)?fetcher=fetchGithubFile:VALID_GIST.test(id)||(fetcher=-1!==id.indexOf("%3A%2F%2F")?fetchAnyUrl:fetchLocalSnippet),fetchers.push(fetcher);var returnCount=0,successful=!1;$.each(fetchers,function(){this(id,success,error)})}function readSourceId(event){var $target=$(event.target);if(13===event.which||9===event.which){event.preventDefault(),$target.blur();var gist=$.trim($target.val());if(-1!==gist.indexOf("/")){var dropboxPublicBaseLen=DROPBOX_PUBLIC_BASE_URL.length,dropboxPrivateBaseLen=DROPBOX_PRIVATE_BASE_URL.length;if(gist.length>dropboxPublicBaseLen&&gist.substr(0,dropboxPublicBaseLen)===DROPBOX_PUBLIC_BASE_URL)gist="dropbox-"+encodeURIComponent(gist.substr(dropboxPublicBaseLen));else if(gist.length>dropboxPrivateBaseLen&&gist.substr(0,dropboxPrivateBaseLen)===DROPBOX_PRIVATE_BASE_URL)gist="dropboxs-"+encodeURIComponent(gist.substr(dropboxPrivateBaseLen));else if(gist.length>30&&("https://github.com/"===gist.substr(0,19)||"https://raw.github.com/"===gist.substr(0,23))){var parts=gist.split("/"),isRaw="raw.github.com"===parts[2],pathIndex=isRaw?6:7,branchIndex=isRaw?5:6;parts.length>=pathIndex&&(gist="github-"+parts[3]+"/"+parts[4],"master"!==parts[branchIndex]&&(gist+="/"+parts[branchIndex]),gist+="//"+parts.slice(pathIndex).join("/")),gist=encodeURIComponent(gist)}else{var pos=gist.lastIndexOf("/"),endOfUrl=gist.substr(pos+1);gist=-1===gist.indexOf("://")||VALID_GIST.test(endOfUrl)?endOfUrl:encodeURIComponent(gist)}}"?"===gist.charAt(0)&&(gist=gist.substr(1)),window.location.assign("?"+gist)}}function fetchGithubGist(gist,success,error){if(!VALID_GIST.test(gist))return void error("The gist id is malformed: "+gist);var url="https://api.github.com/gists/"+gist.replace("/","");$.ajax({url:url,success:function(data){var file=data.files[Object.keys(data.files)[0]],content=file.content,link=data.html_url;success(content,link)},dataType:"json",error:function(xhr,status,errorMessage){error(errorMessage)}})}function fetchGithubFile(gist,success,error){gist=gist.substr(7);var decoded=decodeURIComponent(gist),parts=decoded.split("/"),branch="master",pathPartsIndex=3;if(-1!==decoded.indexOf("/contents/"))return void window.location.assign("?github-"+encodeURIComponent(decoded.replace("/contents/","//")));parts.length>=4&&""===parts[3]&&(branch=parts[2],pathPartsIndex++);var url="https://api.github.com/repos/"+parts[0]+"/"+parts[1]+"/contents/"+parts.slice(pathPartsIndex).join("/");$.ajax({url:url,data:{ref:branch},success:function(data){var content=Base64.decode(data.content),link=data.html_url,imagesdir="https://raw.github.com/"+parts[0]+"/"+parts[1]+"/"+branch+"/"+data.path.substring(0,-data.name.length);success(content,link,imagesdir)},dataType:"json",error:function(xhr,status,errorMessage){error(errorMessage)}})}function fetchPublicDropboxFile(id,success,error){id=id.substr(8),fetchDropboxFile(id,success,error,DROPBOX_PUBLIC_BASE_URL)}function fetchPrivateDropboxFile(id,success,error){id=id.substr(9),fetchDropboxFile(id,success,error,DROPBOX_PRIVATE_API_BASE_URL)}function fetchDropboxFile(id,success,error,baseUrl){var url=baseUrl+decodeURIComponent(id);$.ajax({url:url,success:function(data){success(data,url)},dataType:"text",error:function(xhr,status,errorMessage){error(errorMessage)}})}function fetchAnyUrl(id,success,error){var url=decodeURIComponent(id);$.ajax({url:url,success:function(data){success(data,url)},dataType:"text",error:function(xhr,status,errorMessage){error(errorMessage)}})}function neo4jGistFetcher(id,success,error){var url="http://www.neo4j.org/api/graphgist?"+id;$.ajax({url:url,success:function(data,status,res){var source=res.getResponseHeader("GraphGist-Source");success(data,source||url)},dataType:"text",error:function(xhr,status,errorMessage){error(errorMessage)}})}function fetchLocalSnippet(id,success,error){var url="./gists/"+id+".adoc";$.ajax({url:url,success:function(data){var link="https://github.com/neo4j-contrib/graphgist/tree/master/gists/"+id+".adoc";success(data,link)},dataType:"text",error:function(xhr,status,errorMessage){error(errorMessage)}})}function errorMessage(message,gist){var messageText;messageText=gist?'Something went wrong fetching the GraphGist "'+gist+'":<p>'+message+"</p>":"<p>"+message+"</p>",$content.html('<div class="alert alert-block alert-error"><h4>Error</h4>'+messageText+"</div>")}var DROPBOX_PUBLIC_BASE_URL="https://dl.dropboxusercontent.com/u/",DROPBOX_PRIVATE_BASE_URL="https://www.dropbox.com/s/",DROPBOX_PRIVATE_API_BASE_URL="https://dl.dropboxusercontent.com/s/",VALID_GIST=/^[0-9a-f]{5,32}\/?$/;return{getGistAndRenderPage:getGistAndRenderPage,readSourceId:readSourceId}}function DotWrapper($){function scanForScriptBlocks(){(document.createElementNS||!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect)&&$('script[type="text/vnd.graphviz"]').each(function(){var $script=$(this),dot=$script.html();insertSvg(dot,$script)})}function insertSvg(dot,$element){function executeAndInsert(dotSource,$elementTarget){try{var svg=Viz(dotSource,"svg");$elementTarget.after(svg)}catch(ex){console.log("Graphviz rendering failed:\n",ex)}}vizLoaded?executeAndInsert(dot,$element):loading?queue.push({dot:dot,element:$element}):(loading=!0,queue.push({dot:dot,element:$element}),$.ajax({url:"js/viz.js",dataType:"script",cache:!0,success:function(){vizLoaded=!0,$.each(queue,function(){executeAndInsert(this.dot,this.element)})}}))}var vizLoaded=!1,loading=!1,queue=[];return{scan:scanForScriptBlocks}}function GraphGist($){function renderContent(originalContent,link,imagesdir){$("#gist_link").attr("href",link).removeClass("disabled");var doc=preProcessContents(originalContent);$content.empty();var generatedHtml=void 0;try{generatedHtml=Opal.Asciidoctor.$render(doc,ASCIIDOCTOR_OPTIONS)}catch(e){return void errorMessage("Error while parsing the AsciiDoc source - "+e.name+":<p>"+e.message+"</p>")}$content.html(generatedHtml),"initSocial"in window&&(initSocial(initAndGetHeading()),share()),window.setTimeout(function(){initDisqus($content)},5e3);var version=postProcessPage(),consoleUrl=CONSOLE_VERSIONS[version in CONSOLE_VERSIONS?version:DEFAULT_VERSION];CypherConsole({url:consoleUrl},function(conslr){consolr=conslr,executeQueries(function(){initConsole(function(){renderGraphs(),renderTables()},function(){postProcessRendering()})})})}function postProcessRendering(){$('span[data-toggle="tooltip"]').tooltip({placement:"left"}),$("a.run-query,a.edit-query,a.show-console-toggle").tooltip({placement:"right"}),$(".tooltip-below").tooltip({placement:"bottom"});var $status=$("#status");HAS_ERRORS?($status.text("Errors."),$status.addClass("label-important")):($status.text("No Errors."),$status.addClass("label-success")),DotWrapper($).scan(),initDisqus($content)}function preProcessContents(content){var sanitized=content.replace(/^\/\/\s*?console/m,'++++\n<p class="console"><span class="loading"><i class="icon-cogs"></i> Running queries, preparing the console!</span></p>\n++++\n');return sanitized=sanitized.replace(/^\/\/\s*?hide/gm,'++++\n<span class="hide-query"></span>\n++++\n'),sanitized=sanitized.replace(/^\/\/\s*?setup/gm,'++++\n<span class="setup"></span>\n++++\n'),sanitized=sanitized.replace(/^\/\/\s*?graph_result.*/gm,'++++\n<h5 class="graph-visualization" graph-mode="result"><img alt="loading" class="loading" src="http://gist.neo4j.org/images/loading.gif"></h5>\n++++\n'),sanitized=sanitized.replace(/^\/\/\s*?graph.*/gm,'++++\n<h5 class="graph-visualization"><img alt="loading" src="http://gist.neo4j.org/images/loading.gif" class="loading"></h5>\n++++\n'),sanitized=sanitized.replace(/^\/\/\s*?output.*/gm,'++++\n<span class="query-output"></span>\n++++\n'),sanitized=sanitized.replace(/^\/\/\s*?table.*/gm,'++++\n<h5 class="result-table"></h5>\n++++\n'),sanitized+='\n[subs="attributes"]\n++++\n<span id="metadata"\n author="{author}"\n version="{neo4j-version}"\n twitter="{twitter}"\n tags="{tags}"\n/>\n++++\n'}function processMathJAX(){MathJax.Hub.Typeset()}function formUrl(url,title,author,twitter){return"https://docs.google.com/a/neotechnology.com/forms/d/1HQG5x3g8ig3LTjWGM3G2X_zx9tgmN2ltH4AOBvXajwY/viewform?entry.718349727="+encodeURIComponent(url)+"&entry.1981612324="+encodeURIComponent(title.length>18?title.substr(0,title.length-18):title)+"&entry.1328778537="+encodeURIComponent(author)+"&entry.507462214="+encodeURIComponent(twitter)}function initAndGetHeading(){var headingText="Neo4j GraphGist",heading=$("h1").first();return heading.length||(heading=$("h2").first()),heading.length&&(headingText=heading.text(),document.title=headingText+" - Neo4j GraphGist"),headingText}function postProcessPage(){var $meta=$("#metadata",$content),version=$meta.attr("version"),tags=$meta.attr("tags"),author=$meta.attr("author"),twitter=$meta.attr("twitter");"{tags}"===tags&&(tags=!1),"{author}"===author&&(author=!1),"{twitter}"===twitter&&(twitter=!1),"undefined"!=typeof version&&version in CONSOLE_VERSIONS||(version=DEFAULT_VERSION);var $footer=$("footer");if(tags&&$footer.prepend('<i class="icon-tags"></i> Tags <em>'+tags+"</a> "),twitter&&(twitter=twitter.replace("@","")),twitter&&!author&&(author=twitter),author){var authorHtml="<i class="+(twitter?'"icon-twitter-sign"':'"icon-user"')+"></i> Author ";twitter&&(authorHtml+='<a target="_blank" href="http://twitter.com/'+twitter+'">'),authorHtml+=author,twitter&&(authorHtml+="</a>"),authorHtml+=" ",$footer.prepend(authorHtml)}$footer.prepend('<i class="icon-check"></i><a target="_blank" title="Submit an original GraphGist and get a Neo4j t-shirt" href="'+formUrl(window.location.href,document.title,author,twitter)+'"> Submit</a> '),$footer.prepend('<i class="icon-cogs"></i> Uses Neo4j Version <a target="_blank" href="http://docs.neo4j.org/chunked/'+version+'/cypher-query-lang.html">'+version+"</a> "),$("h2[id]").css({cursor:"pointer"}).click(function(){window.location.href=window.location.href.replace(/($|#.+?$)/,"#"+$(this).attr("id"))}),processMathJAX(),findQuery("span.hide-query",$content,function(codeElement){$(codeElement.parentNode).addClass("hide-query")}),findQuery("span.setup",$content,function(codeElement){$(codeElement.parentNode).addClass("setup-query")}),findQuery("span.query-output",$content,function(codeElement){$(codeElement.parentNode).data("show-output",!0)});var number=0;return $("code",$content).each(function(index,el){var $el=$(el);if($el.hasClass("cypher")){number++;var $parent=$el.parent();$parent.addClass("with-buttons"),$el.attr("data-lang","cypher"),$parent.prepend("<h5>Query "+number+"</h5>"),$el.wrap($WRAPPER).each(function(){$el.parent().data("query",$el.text())});var $toggleQuery=$QUERY_TOGGLE_BUTTON.clone();if($parent.append($toggleQuery),$toggleQuery.click(function(){var $icon=$("i",this),$queryWrapper=$icon.parent().prevAll("div.query-wrapper").first(),action=toggler($queryWrapper,this);if("hide"===action){var $queryMessage=$queryWrapper.nextAll("pre.query-message").first();$icon=$queryWrapper.nextAll("span.result-toggle").first(),toggler($queryMessage,$icon,"hide")}}),$parent.hasClass("hide-query")){var $wrapper=$toggleQuery.prevAll("div.query-wrapper").first();toggler($wrapper,$toggleQuery,"hide")}}else $el.hasClass("sql")?$el.attr("data-lang","sql"):$el.hasClass("java")?$el.attr("data-lang","java"):$el.hasClass("xml")&&$el.attr("data-lang","xml")}),CodeMirror.colorize(),$("table").addClass("table"),version}function initConsole(callback,always){function success(){consolr.input(""),callback&&callback(),always&&always()}function error(data){HAS_ERRORS=!0,console.log("Error during INIT: ",data),always&&always()}var query=getSetupQuery();consolr.init({init:"none",query:query||"none",message:"none",viz:"none",no_root:!0},success,error)}function executeQueries(callbackAfter){function success(data,resultNo){receivedResults++;
var $wrapper=$wrappers[resultNo],showOutput=$wrapper.parent().data("show-output");createQueryResultButton($QUERY_OK_LABEL,$wrapper,data.result,!showOutput),$wrapper.data("visualization",data.visualization),$wrapper.data("data",data),callbackAfter&&receivedResults===statements.length&&callbackAfter()}function error(data,resultNo){HAS_ERRORS=!0,receivedResults++;var $wrapper=$wrappers[resultNo];createQueryResultButton($QUERY_ERROR_LABEL,$wrapper,data.error,!1),callbackAfter&&receivedResults===statements.length&&callbackAfter()}var statements=[],$wrappers=[],receivedResults=0;$("div.query-wrapper").each(function(index,element){var $wrapper=$(element),number=index+1;$wrapper.data("number",number);var statement=$wrapper.data("query");statements.push(statement),$wrappers.push($wrapper)}),statements.length>0?consolr.query(statements,success,error):postProcessRendering()}function getSetupQuery(){var queries=[];return $("#content pre.highlight.setup-query > div.query-wrapper").each(function(){var $wrapper=$(this),query=$.trim($wrapper.data("query"));return 0===query.length?!0:(";"===query.slice(-1)&&(query=query.slice(0,-1)),queries.push($.trim(query)),void $wrapper.prevAll("h5").first().each(function(){var $heading=$(this);$heading.text($heading.text()+" — this query has been used to initialize the console")}))}),0===queries.length?void 0:queries.join(";\n")}function renderGraphs(){var counter=0;findPreviousQueryWrapper("h5.graph-visualization",$content,function($heading,$wrapper){function performVisualizationRendering(){function fullscreenClick(){$visContainer.hasClass("fullscreen")?($("body").unbind("keydown",keyHandler),contract()):(expand(),$("body").keydown(keyHandler))}function expand(){$visContainer.addClass("fullscreen"),$visContainer.height("100%"),"expand"in subscriptions&&subscriptions.expand()}function contract(){$visContainer.removeClass("fullscreen"),$visContainer.height(400),"contract"in subscriptions&&subscriptions.contract()}function sizeChange(){"sizeChange"in subscriptions&&subscriptions.sizeChange()}function keyHandler(event){"which"in event&&27===event.which&&contract()}if(visualization){var rendererHooks=neod3Renderer.render(id,$visContainer,selectedVisualization),subscriptions="subscriptions"in rendererHooks?rendererHooks.subscriptions:{},actions="actions"in rendererHooks?rendererHooks.actions:{},$visualizationIcons=$VISUALIZATION_ICONS.clone().appendTo($visContainer);$visualizationIcons.children("i.fullscreen-icon").click(fullscreenClick);for(var iconName in actions){var actionData=actions[iconName];$I.clone().addClass(iconName).attr("title",actionData.title).appendTo($visualizationIcons).click(actionData.func)}$visContainer.mutate("width",sizeChange)}else $visContainer.text("There is no graph to render.").addClass("alert-error")}var visualization=$wrapper.data("visualization"),id="graph-visualization-"+counter++,$visContainer=$VISUALIZATION.clone().attr("id",id).insertAfter($heading),show_result_only=$heading.attr("graph-mode")&&-1!==$heading.attr("graph-mode").indexOf("result"),selectedVisualization=handleSelection(visualization,show_result_only);$heading.remove(),$visContainer.height(VISUALIZATION_HEIGHT),performVisualizationRendering()})}function handleSelection(data,show_result_only){if(!show_result_only)return data;var i,nodes=[],links=[];for(i=0;i<data.nodes.length;i++){var node=data.nodes[i];node.selected&&(node.$index=nodes.length,nodes.push(node))}var hasSelectedRels=data.links.filter(function(link){return link.selected}).length>0;for(i=0;i<data.links.length;i++){var link=data.links[i];(link.selected||!hasSelectedRels&&data.nodes[link.source].selected&&data.nodes[link.target].selected)&&(link.source=data.nodes[link.source].$index,link.target=data.nodes[link.target].$index,links.push(link))}return{nodes:nodes,links:links}}function renderTables(){findPreviousQueryWrapper("h5.result-table",$content,function($heading,$wrapper){var $tableContainer=$TABLE_CONTAINER.clone().insertAfter($heading);$heading.remove(),renderTable($tableContainer,$wrapper.data("data"))||$tableContainer.text("Couldn't render the result table.").addClass("alert-error")})}function replaceNewlines(str){return str.replace(/\\n/g,"&#013;")}function createQueryResultButton($labelType,$wrapper,message,hide){var $label=$labelType.clone(),$button=$RESULT_TOGGLE_BUTTON.clone();$wrapper.after($label).after($button);var $message=$QUERY_MESSAGE.clone().text(replaceNewlines(message));hide?toggler($message,$button,"hide"):toggler($message,$button,"show"),$button.click(function(){toggler($message,$button)}),$wrapper.after($message)}function toggler($target,button,action){var $icon=$("i",button),stateIsExpanded=$icon.hasClass(COLLAPSE_ICON);return action&&"hide"===action||void 0===action&&stateIsExpanded?($target.hide(),$icon.removeClass(COLLAPSE_ICON).addClass(EXPAND_ICON),"hide"):($target.show(),$icon.removeClass(EXPAND_ICON).addClass(COLLAPSE_ICON),"show")}function findQuery(selector,context,operation){$(selector,context).each(function(){$(this).nextAll("div.listingblock").children("div").children("pre.highlight").children("code.cypher").first().each(function(){operation(this)})})}function findPreviousQueryWrapper(selector,context,operation){$(selector,context).each(function(){var $selected=$(this);findPreviousQueryWrapperSearch($selected,$selected,operation)})}function findPreviousQueryWrapperSearch($container,$selected,operation){var done=!1;if(done=findQueryWrapper($container,$selected,operation))return!0;var $newContainer=$container.prev();if($newContainer.length>0)return findPreviousQueryWrapperSearch($newContainer,$selected,operation);var $up=$container.parent();return(done=0===$up.length||"BODY"===$up.prop("tagName").toUpperCase())?done:findPreviousQueryWrapperSearch($up,$selected,operation)}function findQueryWrapper($container,$selected,operation){var done=!1;return $container.find("div.query-wrapper").last().each(function(){operation($selected,$(this)),done=!0}),done}function errorMessage(message,gist){var messageText;messageText=gist?'Something went wrong fetching the GraphGist "'+gist+'":<p>'+message+"</p>":"<p>"+message+"</p>",$content.html('<div class="alert alert-block alert-error"><h4>Error</h4>'+messageText+"</div>")}"support"in $&&($.support.cors=!0);var HAS_ERRORS=!1,$WRAPPER=$('<div class="query-wrapper" />'),COLLAPSE_ICON="icon-minus-sign-alt",EXPAND_ICON="icon-plus-sign-alt",$QUERY_OK_LABEL=$('<span class="label label-success query-info">Test run OK</span>'),$QUERY_ERROR_LABEL=$('<span class="label label-important query-info">Test run Error</span>'),$TOGGLE_BUTTON=$('<span data-toggle="tooltip"><i class="'+COLLAPSE_ICON+'"></i></span>'),$QUERY_TOGGLE_BUTTON=$TOGGLE_BUTTON.clone().addClass("query-toggle").attr("title","Show/hide query."),$RESULT_TOGGLE_BUTTON=$TOGGLE_BUTTON.clone().addClass("result-toggle").attr("title","Show/hide result."),$QUERY_MESSAGE=$("<pre/>").addClass("query-message"),$VISUALIZATION=$("<div/>").addClass("visualization"),VISUALIZATION_HEIGHT=400,$TABLE_CONTAINER=$("<div/>").addClass("result-table"),ASCIIDOCTOR_OPTIONS=Opal.hash("attributes",["notitle!"],"attribute-missing","drop"),DEFAULT_SOURCE="github-neo4j-contrib%2Fgists%2F%2Fmeta%2FHome.adoc",$VISUALIZATION_ICONS=$('<div class="visualization-icons"><i class="icon-fullscreen fullscreen-icon" title="Toggle fullscreen mode"></i></div>'),$I=$("<i/>"),DEFAULT_VERSION="2.1",CONSOLE_VERSIONS={"2.0.0-M06":"http://neo4j-console-20m06.herokuapp.com/","2.0.0-RC1":"http://neo4j-console-20rc1.herokuapp.com/","2.0.0":"http://neo4j-console-20.herokuapp.com/","2.0.1":"http://neo4j-console-20.herokuapp.com/","2.0.2":"http://neo4j-console-20.herokuapp.com/","2.0.3":"http://neo4j-console-20.herokuapp.com/","2.0.4":"http://neo4j-console-20.herokuapp.com/","2.1.0":"http://neo4j-console-21.herokuapp.com/","2.1.1":"http://neo4j-console-21.herokuapp.com/","2.1.2":"http://neo4j-console-21.herokuapp.com/","2.1.3":"http://neo4j-console-21.herokuapp.com/",2.1:"http://neo4j-console-21.herokuapp.com/",local:"http://localhost:8080/",1.9:"http://neo4j-console-19.herokuapp.com/"},neod3Renderer=new Neod3Renderer,$content=void 0,$gistId=void 0,consolr=void 0;$(document).ready(function(){$content=$("#content"),$gistId=$("#gist-id");var gist=new Gist($,$content);gist.getGistAndRenderPage(renderContent,DEFAULT_SOURCE),$gistId.keydown(gist.readSourceId)})}var CHAR_WIDTH=8,$TABLE=$('<table cellpadding="0" cellspacing="0" border="0"></table>');!function(){var __hasProp={}.hasOwnProperty;window.neo={},neo.models={},neo.renderers={node:[],relationship:[]},neo.utils={copy:function(src){return JSON.parse(JSON.stringify(src))},extend:function(dest,src){var k,v;if(neo.utils.isObject(dest)||!neo.utils.isObject(src)){for(k in src)__hasProp.call(src,k)&&(v=src[k],dest[k]=v);return dest}},isArray:Array.isArray||function(obj){return"[object Array]"===Object.prototype.toString.call(obj)},isObject:function(obj){return Object(obj)===obj}};var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__slice=[].slice;neo.models.Graph=function(){function Graph(cypher){this.removeRelationships=__bind(this.removeRelationships,this),this.removeNodes=__bind(this.removeNodes,this),this.findRelationship=__bind(this.findRelationship,this),this.findNode=__bind(this.findNode,this),this.addRelationships=__bind(this.addRelationships,this),this.addNodes=__bind(this.addNodes,this),this.nodeMap={},this.relationshipMap={},cypher&&(this.addNodes(cypher.nodes),this.addRelationships(cypher.relationships))}return Graph.prototype.nodes=function(){var key,value,_ref,_results;_ref=this.nodeMap,_results=[];for(key in _ref)__hasProp.call(_ref,key)&&(value=_ref[key],_results.push(value));return _results},Graph.prototype.relationships=function(){var key,value,_ref,_results;_ref=this.relationshipMap,_results=[];for(key in _ref)__hasProp.call(_ref,key)&&(value=_ref[key],_results.push(value));return _results},Graph.prototype.addNodes=function(item){var items,node,_base,_i,_len,_name;for(items=neo.utils.isArray(item)?item:[item],_i=0,_len=items.length;_len>_i;_i++)item=items[_i],node=item instanceof neo.models.Node?item:new neo.models.Node(item.id,item.labels,item.properties),(_base=this.nodeMap)[_name=item.id]||(_base[_name]=node);return this},Graph.prototype.addRelationships=function(item){var items,source,target,_i,_len;for(items=neo.utils.isArray(item)?item:[item],_i=0,_len=items.length;_len>_i;_i++)item=items[_i],source=this.nodeMap[item.source]||function(){throw"Invalid source"}(),target=this.nodeMap[item.target]||function(){throw"Invalid target"}(),this.relationshipMap[item.id]=new neo.models.Relationship(item.id,source,target,item.type,item.properties);return this},Graph.prototype.findNode=function(id){return this.nodeMap[id]},Graph.prototype.findRelationship=function(id){return this.relationshipMap[id]},Graph.prototype.merge=function(result){return this.addNodes(result.nodes),this.addRelationships(result.relationships),this},Graph.prototype.removeNodes=function(){var id,rId,rel,rels,remove,_i,_len;if(remove=1<=arguments.length?__slice.call(arguments,0):[],0===arguments.length)return this.nodeMap={},this.relationshipMap={},this;for(remove=neo.utils.isArray(remove[0])?remove[0]:remove,_i=0,_len=remove.length;_len>_i;_i++)id=remove[_i],rels=function(){var _ref,_results;_ref=this.relationshipMap,_results=[];for(rId in _ref)__hasProp.call(_ref,rId)&&(rel=_ref[rId],(rel.source.id===id||rel.target.id===id)&&_results.push(rel.id));return _results}.call(this),this.removeRelationships(rels),delete this.nodeMap[id];return this},Graph.prototype.removeRelationships=function(){var id,remove,_i,_len;if(remove=1<=arguments.length?__slice.call(arguments,0):[],0===arguments.length)return this.relationshipMap={},this;for(remove=neo.utils.isArray(remove[0])?remove[0]:remove,_i=0,_len=remove.length;_len>_i;_i++)id=remove[_i],delete this.relationshipMap[id];return this},Graph}();var NeoD3Geometry;NeoD3Geometry=function(){function NeoD3Geometry(style){this.style=style}var addShortenedNextWord,fitCaptionIntoCircle,noEmptyLines,square;return square=function(distance){return distance*distance},addShortenedNextWord=function(line,word,measure){var _results;for(_results=[];!(word.length<=2);){if(word=word.substr(0,word.length-2)+"…",measure(word)<line.remainingWidth){line.text+=" "+word;break}_results.push(void 0)}return _results},noEmptyLines=function(lines){var line,_i,_len;for(_i=0,_len=lines.length;_len>_i;_i++)if(line=lines[_i],0===line.text.length)return!1;return!0},NeoD3Geometry.prototype.formatNodeCaptions=function(nodes){var captionText,i,lines,node,template,words,_i,_j,_len,_ref,_results,style=this.style;for(_results=[],_i=0,_len=nodes.length;_len>_i;_i++){for(node=nodes[_i],template=style.forNode(node).get("caption"),captionText=style.interpolate(template,node.id,node.propertyMap),words=captionText.split(" "),lines=[],i=_j=0,_ref=words.length-1;_ref>=0?_ref>=_j:_j>=_ref;i=_ref>=0?++_j:--_j)lines.push({node:node,text:words[i],baseline:10*(1+i-words.length/2)});_results.push(node.caption=lines)}return _results},fitCaptionIntoCircle=function(node,style){var candidateLines,candidateWords,captionText,consumedWords,emptyLine,fitOnFixedNumberOfLines,fontFamily,fontSize,lineCount,lineHeight,lines,maxLines,measure,template,words,_i,_ref,_ref1;for(template=style.forNode(node).get("caption"),captionText=style.interpolate(template,node.id,node.propertyMap),fontFamily="sans-serif",fontSize=parseFloat(style.forNode(node).get("font-size")),lineHeight=fontSize,measure=function(text){return neo.utils.measureText(text,fontFamily,fontSize)},words=captionText.split(" "),emptyLine=function(lineCount,iLine){var baseline,constainingHeight,lineWidth;return baseline=(1+iLine-lineCount/2)*lineHeight,constainingHeight=lineCount/2>iLine?baseline-lineHeight:baseline,lineWidth=2*Math.sqrt(square(node.radius)-square(constainingHeight)),{node:node,text:"",baseline:baseline,remainingWidth:lineWidth}},fitOnFixedNumberOfLines=function(lineCount){var iLine,iWord,line,lines,_i,_ref;for(lines=[],iWord=0,iLine=_i=0,_ref=lineCount-1;_ref>=0?_ref>=_i:_i>=_ref;iLine=_ref>=0?++_i:--_i){for(line=emptyLine(lineCount,iLine);iWord<words.length&&measure(" "+words[iWord])<line.remainingWidth;)line.text+=" "+words[iWord],line.remainingWidth-=measure(" "+words[iWord]),iWord++;lines.push(line)}return iWord<words.length&&addShortenedNextWord(lines[lineCount-1],words[iWord],measure),[lines,iWord]},consumedWords=0,maxLines=2*node.radius/fontSize,lines=[emptyLine(1,0)],lineCount=_i=1;maxLines>=1?maxLines>=_i:_i>=maxLines;lineCount=maxLines>=1?++_i:--_i)if(_ref=fitOnFixedNumberOfLines(lineCount),candidateLines=_ref[0],candidateWords=_ref[1],noEmptyLines(candidateLines)&&(_ref1=[candidateLines,candidateWords],lines=_ref1[0],consumedWords=_ref1[1]),consumedWords>=words.length)return lines;return lines},NeoD3Geometry.prototype.measureRelationshipCaption=function(relationship,caption){var fontFamily,fontSize,padding;return fontFamily="sans-serif",fontSize=parseFloat(this.style.forRelationship(relationship).get("font-size")),padding=parseFloat(this.style.forRelationship(relationship).get("padding")),neo.utils.measureText(caption,fontFamily,fontSize)+2*padding},NeoD3Geometry.prototype.captionFitsInsideArrowShaftWidth=function(relationship){return parseFloat(this.style.forRelationship(relationship).get("shaft-width"))>parseFloat(this.style.forRelationship(relationship).get("font-size"))},NeoD3Geometry.prototype.measureRelationshipCaptions=function(relationships){var relationship,_i,_len,_results;for(_results=[],_i=0,_len=relationships.length;_len>_i;_i++)relationship=relationships[_i],relationship.captionLength=this.measureRelationshipCaption(relationship,relationship.type),_results.push(relationship.captionLayout=this.captionFitsInsideArrowShaftWidth(relationship)?"internal":"external");return _results},NeoD3Geometry.prototype.shortenCaption=function(relationship,caption,targetWidth){var shortCaption,width;for(shortCaption=caption;;){if(shortCaption.length<=2)return["",0];if(shortCaption=shortCaption.substr(0,shortCaption.length-2)+"…",width=this.measureRelationshipCaption(relationship,shortCaption),targetWidth>width)return[shortCaption,width]}},NeoD3Geometry.prototype.layoutRelationships=function(relationships){var alongPath,dx,dy,endBreak,headHeight,headRadius,length,relationship,shaftLength,shaftRadius,startBreak,_i,_len,_ref,_results;for(_results=[],_i=0,_len=relationships.length;_len>_i;_i++)relationship=relationships[_i],dx=relationship.target.x-relationship.source.x,dy=relationship.target.y-relationship.source.y,length=Math.sqrt(square(dx)+square(dy)),relationship.arrowLength=length-relationship.source.radius-relationship.target.radius,alongPath=function(from,distance){return{x:from.x+dx*distance/length,y:from.y+dy*distance/length}},shaftRadius=parseFloat(this.style.forRelationship(relationship).get("shaft-width"))/2||2,headRadius=shaftRadius+3,headHeight=2*headRadius,shaftLength=relationship.arrowLength-headHeight,relationship.startPoint=alongPath(relationship.source,relationship.source.radius),relationship.endPoint=alongPath(relationship.target,-relationship.target.radius),relationship.midShaftPoint=alongPath(relationship.startPoint,shaftLength/2),relationship.angle=Math.atan2(dy,dx)/Math.PI*180,relationship.textAngle=relationship.angle,(relationship.angle<-90||relationship.angle>90)&&(relationship.textAngle+=180),_ref=shaftLength>relationship.captionLength?[relationship.type,relationship.captionLength]:this.shortenCaption(relationship,relationship.type,shaftLength),relationship.shortCaption=_ref[0],relationship.shortCaptionLength=_ref[1],"external"===relationship.captionLayout?(startBreak=(shaftLength-relationship.shortCaptionLength)/2,endBreak=shaftLength-startBreak,_results.push(relationship.arrowOutline=["M",0,shaftRadius,"L",startBreak,shaftRadius,"L",startBreak,-shaftRadius,"L",0,-shaftRadius,"Z","M",endBreak,shaftRadius,"L",shaftLength,shaftRadius,"L",shaftLength,headRadius,"L",relationship.arrowLength,0,"L",shaftLength,-headRadius,"L",shaftLength,-shaftRadius,"L",endBreak,-shaftRadius,"Z"].join(" "))):_results.push(relationship.arrowOutline=["M",0,shaftRadius,"L",shaftLength,shaftRadius,"L",shaftLength,headRadius,"L",relationship.arrowLength,0,"L",shaftLength,-headRadius,"L",shaftLength,-shaftRadius,"L",0,-shaftRadius,"Z"].join(" "));return _results},NeoD3Geometry.prototype.setNodeRadii=function(nodes){var node,_i,_len,_results;for(_results=[],_i=0,_len=nodes.length;_len>_i;_i++)node=nodes[_i],_results.push(node.radius=parseFloat(this.style.forNode(node).get("diameter"))/2);return _results},NeoD3Geometry.prototype.onGraphChange=function(graph){return this.setNodeRadii(graph.nodes()),this.formatNodeCaptions(graph.nodes()),this.measureRelationshipCaptions(graph.relationships())},NeoD3Geometry.prototype.onTick=function(graph){return this.layoutRelationships(graph.relationships())},NeoD3Geometry}();var __slice=[].slice;neo.graphModel=function(){var graph,model;return graph=new neo.models.Graph,model=function(){},model.callbacks={},model.trigger=function(){var args,callback,event,_i,_len,_ref,_results;if(event=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],event="updated",model.callbacks[event]){for(_ref=model.callbacks[event],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)callback=_ref[_i],_results.push(callback.apply(null,args));return _results}},model.nodes=function(items){return null==items?graph.nodes():(graph.removeNodes().addNodes(items),model.trigger("nodesAdded"),model)},model.nodes.add=function(items){return null!=items&&(graph.addNodes(items),model.trigger("nodesAdded")),model},model.nodes.find=graph.findNode,model.nodes.remove=function(){return graph.removeNodes.apply(null,arguments),model.trigger("nodesRemoved"),model},model.relationships=function(items){return null==items?graph.relationships():(graph.removeRelationships().addRelationships(items),model.trigger("relationshipsAdded"),model)},model.relationships.add=function(items){return null!=items&&(graph.addRelationships(items),model.trigger("relationshipsAdded")),model},model.relationships.find=graph.findRelationship,model.relationships.remove=function(){return graph.removeRelationships.apply(null,arguments),model.trigger("relationshipsRemoved"),model},model.on=function(event,callback){var _base;return(null!=(_base=model.callbacks)[event]?_base[event]:_base[event]=[]).push(callback),model},model};var __slice=[].slice;neo.graphView=function(){var callbacks,chart,layout,style,trigger,viz;return layout=neo.layout.force(),style=neo.style(),viz=null,callbacks={},trigger=function(){var args,callback,event,_i,_len,_ref,_results;for(event=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],_ref=callbacks[event],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)callback=_ref[_i],_results.push(callback.apply(null,args));return _results},chart=function(selection){selection.each(function(graphModel){return viz||(viz=neo.viz(this,graphModel,layout,style),graphModel.on("updated",function(){return viz.update()}),viz.trigger=trigger),viz.update()})},chart.on=function(event,callback){return(null!=callbacks[event]?callbacks[event]:callbacks[event]=[]).push(callback),chart},chart.layout=function(value){return arguments.length?(layout=value,chart):layout},chart.style=function(value){return arguments.length?(style.importGrass(value),chart):style.toSheet()},chart.width=function(){return arguments.length?chart:viz.width},chart.height=function(){return arguments.length?chart:viz.height},chart.update=function(){return viz.update(),chart},chart},neo.layout=function(){var _layout;return _layout={},_layout.force=function(){var _force;return _force={},_force.init=function(render){var accelerateLayout,d3force,forceLayout,linkDistance;return forceLayout={},linkDistance=60,d3force=d3.layout.force().linkDistance(linkDistance).charge(-1e3).gravity(.3),accelerateLayout=function(){var d3Tick,maxAnimationFramesPerSecond,maxComputeTime,maxStepsPerTick,now;return maxStepsPerTick=100,maxAnimationFramesPerSecond=60,maxComputeTime=1e3/maxAnimationFramesPerSecond,now=window.performance?function(){return window.performance.now()}:function(){return Date.now()},d3Tick=d3force.tick,d3force.tick=function(){return function(){var startTick,step;for(startTick=now(),step=maxStepsPerTick;step--&&now()-startTick<maxComputeTime;)if(d3Tick())return maxStepsPerTick=2,!0;return render(),!1}}(this)},accelerateLayout(),forceLayout.update=function(graph,size){var center,nodes,radius,relationships;return nodes=graph.nodes(),relationships=graph.relationships(),radius=nodes.length*linkDistance/(2*Math.PI),center={x:size[0]/2,y:size[1]/2},neo.utils.circularLayout(nodes,center,radius),d3force.nodes(nodes).links(relationships).size(size).start()},forceLayout.drag=d3force.drag,forceLayout},_force},_layout}();var __hasProp={}.hasOwnProperty;neo.models.Node=function(){function Node(id,labels,properties){var key,value;this.id=id,this.labels=labels,this.propertyMap=properties,this.propertyList=function(){var _results;_results=[];for(key in properties)__hasProp.call(properties,key)&&(value=properties[key],_results.push({key:key,value:value}));return _results}()}return Node.prototype.toJSON=function(){return this.propertyMap},Node.prototype.isNode=!0,Node.prototype.isRelationship=!1,Node}();var __hasProp={}.hasOwnProperty;neo.models.Relationship=function(){function Relationship(id,source,target,type,properties){var key,value;this.id=id,this.source=source,this.target=target,this.type=type,this.propertyMap=properties,this.propertyList=function(){var _ref,_results;_ref=this.propertyMap,_results=[];for(key in _ref)__hasProp.call(_ref,key)&&(value=_ref[key],_results.push({key:key,value:value}));return _results}.call(this)}return Relationship.prototype.toJSON=function(){return this.propertyMap},Relationship.prototype.isNode=!1,Relationship.prototype.isRelationship=!0,Relationship}(),neo.Renderer=function(){function Renderer(opts){null==opts&&(opts={}),neo.utils.extend(this,opts),null==this.onGraphChange&&(this.onGraphChange=function(){}),null==this.onTick&&(this.onTick=function(){})}return Renderer}(),neo.style=function(){var GraphStyle,Selector,StyleElement,StyleRule,_style;return _style=function(storage){return new GraphStyle(storage)},_style.defaults={autoColor:!0,colors:[{color:"#DFE1E3","border-color":"#D4D6D7","text-color-internal":"#000000"},{color:"#F25A29","border-color":"#DC4717","text-color-internal":"#FFFFFF"},{color:"#AD62CE","border-color":"#9453B1","text-color-internal":"#FFFFFF"},{color:"#30B6AF","border-color":"#46A39E","text-color-internal":"#FFFFFF"},{color:"#FCC940","border-color":"#F3BA25","text-color-internal":"#000000"},{color:"#4356C0","border-color":"#3445A2","text-color-internal":"#FFFFFF"},{color:"#FF6C7C","border-color":"#EB5D6C","text-color-internal":"#FFFFFF"},{color:"#a2cf81","border-color":"#9bbd82","text-color-internal":"#000000"},{color:"#f79235","border-color":"#e68f40","text-color-internal":"#000000"},{color:"#785cc7","border-color":"#625096","text-color-internal":"#FFFFFF"},{color:"#d05e7c","border-color":"#b05b72","text-color-internal":"#FFFFFF"},{color:"#3986b7","border-color":"#3a7499","text-color-internal":"#FFFFFF"}],style:{node:{diameter:"40px",color:"#DFE1E3","border-color":"#D4D6D7","border-width":"2px","text-color-internal":"#000000",caption:"{id}","font-size":"10px"},relationship:{color:"#D4D6D7","shaft-width":"1px","font-size":"8px",padding:"3px","text-color-external":"#000000","text-color-internal":"#FFFFFF"}},sizes:[{diameter:"10px"},{diameter:"20px"},{diameter:"30px"},{diameter:"50px"},{diameter:"80px"}],arrayWidths:[{"shaft-width":"1px"},{"shaft-width":"2px"},{"shaft-width":"3px"},{"shaft-width":"5px"},{"shaft-width":"8px"},{"shaft-width":"13px"},{"shaft-width":"25px"},{"shaft-width":"38px"}]},Selector=function(){function Selector(selector){var _ref;_ref=selector.indexOf(".")>0?selector.split("."):[selector,void 0],this.tag=_ref[0],this.klass=_ref[1]}return Selector.prototype.toString=function(){var str;return str=this.tag,null!=this.klass&&(str+="."+this.klass),str},Selector}(),StyleRule=function(){function StyleRule(selector,props){this.selector=selector,this.props=props}return StyleRule.prototype.matches=function(selector){return this.selector.tag!==selector.tag||this.selector.klass!==selector.klass&&this.selector.klass?!1:!0},StyleRule.prototype.matchesExact=function(selector){return this.selector.tag===selector.tag&&this.selector.klass===selector.klass},StyleRule}(),StyleElement=function(){function StyleElement(selector,data){this.data=data,this.selector=selector,this.props={}}return StyleElement.prototype.applyRules=function(rules){var rule,_i,_j,_len,_len1;for(_i=0,_len=rules.length;_len>_i;_i++)if(rule=rules[_i],rule.matches(this.selector)){neo.utils.extend(this.props,rule.props);break}for(_j=0,_len1=rules.length;_len1>_j;_j++)if(rule=rules[_j],rule.matchesExact(this.selector)){neo.utils.extend(this.props,rule.props);break}return this},StyleElement.prototype.get=function(attr){return this.props[attr]||""},StyleElement}(),GraphStyle=function(){function GraphStyle(storage){this.storage=storage,this.rules=[],this.loadRules()}return GraphStyle.prototype.selector=function(item){return item.isNode?this.nodeSelector(item):item.isRelationship?this.relationshipSelector(item):void 0},GraphStyle.prototype.calculateStyle=function(selector,data){return new StyleElement(selector,data).applyRules(this.rules)},GraphStyle.prototype.forEntity=function(item){return this.calculateStyle(this.selector(item),item)},GraphStyle.prototype.forNode=function(node){var selector,_ref;return null==node&&(node={}),selector=this.nodeSelector(node),(null!=(_ref=node.labels)?_ref.length:void 0)>0&&this.setDefaultStyling(selector),this.calculateStyle(selector,node)},GraphStyle.prototype.forRelationship=function(rel){return this.calculateStyle(this.relationshipSelector(rel),rel)},GraphStyle.prototype.findAvailableDefaultColor=function(){var defaultColor,rule,usedColors,_i,_j,_len,_len1,_ref,_ref1;for(usedColors={},_ref=this.rules,_i=0,_len=_ref.length;_len>_i;_i++)rule=_ref[_i],null!=rule.props.color&&(usedColors[rule.props.color]=!0);for(_ref1=_style.defaults.colors,_j=0,_len1=_ref1.length;_len1>_j;_j++)if(defaultColor=_ref1[_j],null==usedColors[defaultColor.color])return neo.utils.copy(defaultColor);return neo.utils.copy(_style.defaults.colors[0])},GraphStyle.prototype.setDefaultStyling=function(selector){var rule;return rule=this.findRule(selector),_style.defaults.autoColor&&null==rule?(rule=new StyleRule(selector,this.findAvailableDefaultColor()),this.rules.push(rule),this.persist()):void 0},GraphStyle.prototype.change=function(item,props){var rule,selector;return selector=this.selector(item),rule=this.findRule(selector),null==rule&&(rule=new StyleRule(selector,{}),this.rules.push(rule)),neo.utils.extend(rule.props,props),this.persist(),rule},GraphStyle.prototype.destroyRule=function(rule){var idx;return idx=this.rules.indexOf(rule),null!=idx&&this.rules.splice(idx,1),this.persist()},GraphStyle.prototype.findRule=function(selector){var r,rule,_i,_len,_ref;for(_ref=this.rules,_i=0,_len=_ref.length;_len>_i;_i++)r=_ref[_i],r.matchesExact(selector)&&(rule=r);return rule},GraphStyle.prototype.nodeSelector=function(node){var selector,_ref;return null==node&&(node={}),selector="node",(null!=(_ref=node.labels)?_ref.length:void 0)>0&&(selector+="."+node.labels[0]),new Selector(selector)},GraphStyle.prototype.relationshipSelector=function(rel){var selector;return null==rel&&(rel={}),selector="relationship",null!=rel.type&&(selector+="."+rel.type),new Selector(selector)},GraphStyle.prototype.importGrass=function(string){var e,rules;try{return rules=this.parse(string),this.loadRules(rules),this.persist()}catch(_error){e=_error}},GraphStyle.prototype.loadRules=function(data){var props,rule;neo.utils.isObject(data)||(data=_style.defaults.style),this.rules.length=0;for(rule in data)props=data[rule],this.rules.push(new StyleRule(new Selector(rule),neo.utils.copy(props)));return this},GraphStyle.prototype.parse=function(string){var c,chars,insideProps,insideString,k,key,keyword,prop,props,rules,skipThis,v,val,_i,_j,_len,_len1,_ref,_ref1;for(chars=string.split(""),insideString=!1,insideProps=!1,keyword="",props="",rules={},_i=0,_len=chars.length;_len>_i;_i++){switch(c=chars[_i],skipThis=!0,c){case"{":insideString?skipThis=!1:insideProps=!0;break;case"}":insideString?skipThis=!1:(insideProps=!1,rules[keyword]=props,keyword="",props="");break;case"'":case'"':insideString^=!0;break;default:skipThis=!1}skipThis||(insideProps?props+=c:c.match(/[\s\n]/)||(keyword+=c))}for(k in rules)for(v=rules[k],rules[k]={},_ref=v.split(";"),_j=0,_len1=_ref.length;_len1>_j;_j++)prop=_ref[_j],_ref1=prop.split(":"),key=_ref1[0],val=_ref1[1],key&&val&&(rules[k][null!=key?key.trim():void 0]=null!=val?val.trim():void 0);return rules},GraphStyle.prototype.persist=function(){var _ref;return null!=(_ref=this.storage)?_ref.add("grass",JSON.stringify(this.toSheet())):void 0},GraphStyle.prototype.resetToDefault=function(){return this.loadRules(),this.persist()},GraphStyle.prototype.toSheet=function(){var rule,sheet,_i,_len,_ref;for(sheet={},_ref=this.rules,_i=0,_len=_ref.length;_len>_i;_i++)rule=_ref[_i],sheet[rule.selector.toString()]=rule.props;return sheet},GraphStyle.prototype.toString=function(){var k,r,str,v,_i,_len,_ref,_ref1;for(str="",_ref=this.rules,_i=0,_len=_ref.length;_len>_i;_i++){r=_ref[_i],str+=r.selector.toString()+" {\n",_ref1=r.props;for(k in _ref1)v=_ref1[k],"caption"===k&&(v="'"+v+"'"),str+="  "+k+": "+v+";\n";str+="}\n\n"}return str},GraphStyle.prototype.nextDefaultColor=0,GraphStyle.prototype.defaultColors=function(){return neo.utils.copy(_style.defaults.colors)},GraphStyle.prototype.interpolate=function(str,id,properties){return str.replace(/\{([^{}]*)\}/g,function(a,b){var r;return r=properties[b]||id,"string"==typeof r||"number"==typeof r?r:a})},GraphStyle}(),_style}();var __slice=[].slice;
neo.viz=function(el,graph,layout,style){var clickHandler,force,geometry,onNodeClick,onNodeDblClick,onRelationshipClick,render,viz;return viz={style:style},el=d3.select(el),geometry=new NeoD3Geometry(style),viz.trigger=function(){var args,event;event=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[]},onNodeClick=function(){return function(node){return viz.trigger("nodeClicked",node)}}(this),onNodeDblClick=function(){return function(node){return viz.trigger("nodeDblClicked",node)}}(this),onRelationshipClick=function(){return function(relationship){return viz.trigger("relationshipClicked",relationship)}}(this),render=function(){var nodeGroups,relationshipGroups,renderer,_i,_j,_len,_len1,_ref,_ref1,_results;for(geometry.onTick(graph),nodeGroups=el.selectAll("g.node").attr("transform",function(node){return"translate("+node.x+","+node.y+")"}),_ref=neo.renderers.node,_i=0,_len=_ref.length;_len>_i;_i++)renderer=_ref[_i],nodeGroups.call(renderer.onTick,viz);for(relationshipGroups=el.selectAll("g.relationship"),_ref1=neo.renderers.relationship,_results=[],_j=0,_len1=_ref1.length;_len1>_j;_j++)renderer=_ref1[_j],_results.push(relationshipGroups.call(renderer.onTick,viz));return _results},force=layout.init(render),viz.update=function(){var height,layers,nodeGroups,nodes,relationshipGroups,relationships,renderer,width,_i,_j,_len,_len1,_ref,_ref1;if(graph){for(height=function(){try{return parseInt(el.style("height").replace("px",""))}catch(_error){}}(),width=function(){try{return parseInt(el.style("width").replace("px",""))}catch(_error){}}(),layers=el.selectAll("g.layer").data(["relationships","nodes"]),layers.enter().append("g").attr("class",function(d){return"layer "+d}),nodes=graph.nodes(),relationships=graph.relationships(),relationshipGroups=el.select("g.layer.relationships").selectAll("g.relationship").data(relationships,function(d){return d.id}),relationshipGroups.enter().append("g").attr("class","relationship").on("click",onRelationshipClick),geometry.onGraphChange(graph),_ref=neo.renderers.relationship,_i=0,_len=_ref.length;_len>_i;_i++)renderer=_ref[_i],relationshipGroups.call(renderer.onGraphChange,viz);for(relationshipGroups.exit().remove(),nodeGroups=el.select("g.layer.nodes").selectAll("g.node").data(nodes,function(d){return d.id}),nodeGroups.enter().append("g").attr("class","node").call(force.drag).call(clickHandler),_ref1=neo.renderers.node,_j=0,_len1=_ref1.length;_len1>_j;_j++)renderer=_ref1[_j],nodeGroups.call(renderer.onGraphChange,viz);return nodeGroups.exit().remove(),force.update(graph,[width,height])}},clickHandler=neo.utils.clickHandler(),clickHandler.on("click",onNodeClick),clickHandler.on("dblclick",onNodeDblClick),viz},neo.utils.circularLayout=function(nodes,center,radius){var i,n,unlocatedNodes,_i,_len,_results;for(unlocatedNodes=nodes.filter(function(node){return!(null!=node.x&&null!=node.y)}),_results=[],i=_i=0,_len=unlocatedNodes.length;_len>_i;i=++_i)n=unlocatedNodes[i],n.x=center.x+radius*Math.sin(2*Math.PI*i/unlocatedNodes.length),_results.push(n.y=center.y+radius*Math.cos(2*Math.PI*i/unlocatedNodes.length));return _results},neo.utils.distributeCircular=function(arrowAngles,minSeparation){var angle,center,expand,i,key,length,list,rawAngle,result,run,runLength,runsOfTooDenseArrows,tooDense,wrapAngle,wrapIndex,_i,_j,_k,_len,_ref,_ref1,_ref2,_ref3;list=[],_ref=arrowAngles.floating;for(key in _ref)angle=_ref[key],list.push({key:key,angle:angle});for(list.sort(function(a,b){return a.angle-b.angle}),runsOfTooDenseArrows=[],length=function(startIndex,endIndex){return endIndex>startIndex?endIndex-startIndex+1:endIndex+list.length-startIndex+1},angle=function(startIndex,endIndex){return endIndex>startIndex?list[endIndex].angle-list[startIndex].angle:360-(list[startIndex].angle-list[endIndex].angle)},tooDense=function(startIndex,endIndex){return angle(startIndex,endIndex)<length(startIndex,endIndex)*minSeparation},wrapIndex=function(index){return-1===index?list.length-1:index>=list.length?index-list.length:index},wrapAngle=function(angle){return angle>=360?angle-360:angle},expand=function(startIndex,endIndex){if(length(startIndex,endIndex)<list.length){if(tooDense(startIndex,wrapIndex(endIndex+1)))return expand(startIndex,wrapIndex(endIndex+1));if(tooDense(wrapIndex(startIndex-1),endIndex))return expand(wrapIndex(startIndex-1),endIndex)}return runsOfTooDenseArrows.push({start:startIndex,end:endIndex})},i=_i=0,_ref1=list.length-2;_ref1>=0?_ref1>=_i:_i>=_ref1;i=_ref1>=0?++_i:--_i)tooDense(i,i+1)&&expand(i,i+1);for(result={},_j=0,_len=runsOfTooDenseArrows.length;_len>_j;_j++)for(run=runsOfTooDenseArrows[_j],center=list[run.start].angle+angle(run.start,run.end)/2,runLength=length(run.start,run.end),i=_k=0,_ref2=runLength-1;_ref2>=0?_ref2>=_k:_k>=_ref2;i=_ref2>=0?++_k:--_k)rawAngle=center+(i-(runLength-1)/2)*minSeparation,result[list[wrapIndex(run.start+i)].key]=wrapAngle(rawAngle);_ref3=arrowAngles.floating;for(key in _ref3)angle=_ref3[key],result[key]||(result[key]=arrowAngles.floating[key]);return result},neo.utils.clickHandler=function(){var cc,event;return cc=function(selection){var dist,down,last,tolerance,wait;return dist=function(a,b){return Math.sqrt(Math.pow(a[0]-b[0],2),Math.pow(a[1]-b[1],2))},down=void 0,tolerance=5,last=void 0,wait=null,selection.on("mousedown",function(){return d3.event.target.__data__.fixed=!0,down=d3.mouse(document.body),last=+new Date}),selection.on("mouseup",function(){return dist(down,d3.mouse(document.body))>tolerance?void 0:wait?(window.clearTimeout(wait),wait=null,event.dblclick(d3.event.target.__data__)):wait=window.setTimeout(function(e){return function(){return event.click(e.target.__data__),wait=null}}(d3.event),250)})},event=d3.dispatch("click","dblclick"),d3.rebind(cc,event,"on")},neo.utils.measureText=function(){var cache,measureUsingCanvas;return measureUsingCanvas=function(text,font){var canvas,canvasSelection,context;return canvasSelection=d3.select("canvas#textMeasurementCanvas").data([this]),canvasSelection.enter().append("canvas").attr("id","textMeasurementCanvas").style("display","none"),canvas=canvasSelection.node(),context=canvas.getContext("2d"),context.font=font,context.measureText(text).width},cache=function(){var cacheSize,list,map;return cacheSize=1e4,map={},list=[],function(key,calc){var cached,result;return cached=map[key],cached?cached:(result=calc(),list.length>cacheSize&&(delete map[list.splice(0,1)],list.push(key)),map[key]=result)}}(),function(text,fontFamily,fontSize){var font;return font="normal normal normal "+fontSize+"px/normal "+fontFamily,cache(text+font,function(){return measureUsingCanvas(text,font)})}}(),function(){var arrowPath,nodeCaption,nodeOutline,nodeOverlay,noop,relationshipOverlay,relationshipType;return noop=function(){},nodeOutline=new neo.Renderer({onGraphChange:function(selection,viz){var circles;return circles=selection.selectAll("circle.outline").data(function(node){return[node]}),circles.enter().append("circle").classed("outline",!0).attr({cx:0,cy:0}),circles.attr({r:function(node){return node.radius},fill:function(node){return viz.style.forNode(node).get("color")},stroke:function(node){return viz.style.forNode(node).get("border-color")},"stroke-width":function(node){return viz.style.forNode(node).get("border-width")}}),circles.exit().remove()},onTick:noop}),nodeCaption=new neo.Renderer({onGraphChange:function(selection,viz){var text;return text=selection.selectAll("text").data(function(node){return node.caption}),text.enter().append("text").attr({"text-anchor":"middle","font-weight":"bold",stroke:"#FFFFFF","stroke-width":"0"}),text.text(function(line){return line.text}).attr("y",function(line){return line.baseline}).attr("font-size",function(line){return viz.style.forNode(line.node).get("font-size")}).attr("stroke",function(line){return viz.style.forNode(line.node).get("color")}).attr("fill",function(line){return viz.style.forNode(line.node).get("text-color-internal")}),text.exit().remove()},onTick:noop}),nodeOverlay=new neo.Renderer({onGraphChange:function(selection){var circles;return circles=selection.selectAll("circle.overlay").data(function(node){return node.selected?[node]:[]}),circles.enter().insert("circle",".outline").classed("ring",!0).classed("overlay",!0).attr({cx:0,cy:0,fill:"#f5F6F6",stroke:"rgba(151, 151, 151, 0.2)","stroke-width":"3px"}),circles.attr({r:function(node){return node.radius+6}}),circles.exit().remove()},onTick:noop}),arrowPath=new neo.Renderer({onGraphChange:function(selection,viz){var paths;return paths=selection.selectAll("path").data(function(rel){return[rel]}),paths.enter().append("path"),paths.attr("fill",function(rel){return viz.style.forRelationship(rel).get("color")}).attr("stroke","none"),paths.exit().remove()},onTick:function(selection){return selection.selectAll("path").attr("d",function(d){return d.arrowOutline}).attr("transform",function(d){return isNaN(d.startPoint.x)||isNaN(d.startPoint.y)?null:"translate("+d.startPoint.x+" "+d.startPoint.y+") rotate("+d.angle+")"})}}),relationshipType=new neo.Renderer({onGraphChange:function(selection,viz){var texts;return texts=selection.selectAll("text").data(function(rel){return[rel]}),texts.enter().append("text").attr({"text-anchor":"middle"}),texts.attr("font-size",function(rel){return viz.style.forRelationship(rel).get("font-size")}).attr("fill",function(rel){return viz.style.forRelationship(rel).get("text-color-"+rel.captionLayout)}),texts.exit().remove()},onTick:function(selection,viz){return selection.selectAll("text").attr("x",function(rel){return isNaN(rel.midShaftPoint.x)?null:rel.midShaftPoint.x}).attr("y",function(rel){return isNaN(rel.midShaftPoint.y)?null:rel.midShaftPoint.y+parseFloat(viz.style.forRelationship(rel).get("font-size"))/2-1}).attr("transform",function(rel){return isNaN(rel.midShaftPoint.x)||isNaN(rel.midShaftPoint.y)?null:"rotate("+rel.textAngle+" "+rel.midShaftPoint.x+" "+rel.midShaftPoint.y+")"}).text(function(rel){return rel.shortCaption})}}),relationshipOverlay=new neo.Renderer({onGraphChange:function(selection){var band,rects;return rects=selection.selectAll("rect").data(function(rel){return[rel]}),band=20,rects.enter().append("rect").classed("overlay",!0).attr("fill","yellow").attr("x",0).attr("y",-band/2).attr("height",band),rects.attr("opacity",function(rel){return rel.selected?.3:0}),rects.exit().remove()},onTick:function(selection){return selection.selectAll("rect").attr("width",function(d){return d.arrowLength>0?d.arrowLength:0}).attr("transform",function(d){return isNaN(d.startPoint.x)||isNaN(d.startPoint.y)?null:"translate("+d.startPoint.x+" "+d.startPoint.y+") rotate("+d.angle+")"})}}),neo.renderers.node.push(nodeOutline),neo.renderers.node.push(nodeCaption),neo.renderers.node.push(nodeOverlay),neo.renderers.relationship.push(arrowPath),neo.renderers.relationship.push(relationshipType),neo.renderers.relationship.push(relationshipOverlay)}()}(),GraphGist(jQuery),CodeMirror.colorize=function(){function textContent(node,out){if(3==node.nodeType)return out.push(node.nodeValue);for(var ch=node.firstChild;ch;ch=ch.nextSibling)textContent(ch,out),isBlock.test(node.nodeType)&&out.push("\n")}var isBlock=/^(p|li|div|h\\d|pre|blockquote|td)$/;return function(){for(var collection=document.body.getElementsByTagName("code"),i=0;i<collection.length;++i){var theme=" cm-s-default",node=collection[i],mode=node.getAttribute("data-lang");if(mode){"cypher"===mode?theme=" cm-s-neo":"java"===mode?mode="text/x-java":"sql"===mode&&(mode="text/x-sql");var text=[];textContent(node,text),node.innerHTML="",CodeMirror.runMode(text.join(""),mode,node),node.className+=theme}}}}();